ADR-WCF-004: Client UI State Management Strategy
Status: VALIDATED (PoC #3 confirmed)
Date: 2025-06-13 (Initial creation)
Date Validated: 2025-06-13
Authors: WorldChef Mobile Team

1. Context and Problem Statement
The WorldChef Flutter mobile client (ADR-WCF-001a) requires a coherent, scalable, and testable strategy for managing local UI state (theme, offline flag, transient UI flags) and remote server state (data retrieved from the Supabase-backed API â€“ ADR-WCF-003 & ADR-WCF-001d). Historical pitfalls in mobile projects include state bloat, unclear separation of concerns, poor cache invalidation, and brittle optimistic updates. This ADR establishes the official Flutter state-management stack and the guiding patterns that PoC #3 will validate empirically.

2. Decision Drivers
â€¢ Flutter Selected (ADR-WCF-001a): Leverage idiomatic, ecosystem-aligned tooling.
â€¢ Performance & UX: Seamless, instantaneous optimistic updates (<50 ms) and minimal jank.
â€¢ Developer Experience & AI Synergy: Libraries/patterns must be highly automatable by AI with low boilerplate.
â€¢ Testability: 100 % reliable widget/unit tests (PoC #1 outcome) must extend to state logic.
â€¢ Offline Capability: First-class pattern for offline flag & persisted UI state.
â€¢ Scalability: Clear migration path from MVP features to growing data complexity.
â€¢ Consistency with Backend Caching Semantics: Align invalidation with Supabase caching constraints.

3. Considered Options
A. Riverpod 2.x
   â€¢ UI State: NotifierProvider / StateNotifierProvider
   â€¢ Server State: AsyncNotifierProvider (built-in async cache) + dio HTTP client
   Pros: Compile-time safety, granular rebuild control, global provider graph tooling, strong testing, large community.
   Cons: Slight learning curve, manual cache invalidation API.

B. flutter_query (Flutter wrapper of TanStack Query semantics)
   Pros: Familiar React-Query-like API, built-in optimistic updates.
   Cons: Smaller ecosystem, additional dependency layer, less compile-time safety.

C. BLoC + http
   Pros: Historic pattern familiarity.
   Cons: Boilerplate heavy, lower AI generation success (<60 %).

D. Redux Toolkit-like solutions (e.g., AsyncRedux, katana_state)
   Pros: Predictable state tree.
   Cons: Verbose, unfriendly DX, poor async cache semantics.

4. Decision
**Chosen Option: Riverpod 2.x**
UI State â†’ NotifierProvider / StateNotifier (synchronous)
Server State â†’ AsyncNotifierProvider with dio for network calls
Persistence â†’ Hive for lightweight key-value storage (theme) & shared_preferences fallback

Justification:
â€¢ Highest AI code-generation success in preliminary tests (â‰ˆ92 %).
â€¢ Granular rebuilds meet performance targets.
â€¢ Strong testing utilities align with 100 % test reliability goal.
â€¢ ProviderScope-level overrides simplify offline simulations & test doubles.
â€¢ Active, growing ecosystem; maintained by core Flutter community members.

5. Architectural Patterns & Guidelines
5.1 Separation of Concerns
â€¢ UI â†” UI Store (Notifier) â†” Widgets â€“ Pure UI state, no I/O.
â€¢ Server State Providers (AsyncNotifier) handle fetch/mutation logic, caching, optimistic updates.
â€¢ Widgets consume providers via `ref.watch` for reactive updates.

5.2 Optimistic Update Workflow (Like Recipe)
1. User taps ðŸ‘ â†’ Update local cache via `update((state) => â€¦)` inside mutation's `onMutate`.
2. Persist optimistic UI via provider state; emit updated like count.
3. Send HTTP POST; on success â€“ reconcile; on error â€“ rollback & show toast.

5.3 Cache Invalidation & Consistency
â€¢ Each list/detail provider keyed by ID/page (family providers).
â€¢ After successful mutation, call `ref.invalidate(listProvider)` & update detail cache.
â€¢ Global helper `invalidateRelatedCaches(idsâ€¦)` aids AI generation.

5.4 Offline Handling
â€¢ Global `offlineProvider` (Notifier) toggled via connectivity listener.
â€¢ Server state providers early-return cached data when offline & skip network.
â€¢ UI shows banner when `offlineProvider.state == true`.

5.5 Persistence Rules
â€¢ Theme preference & onboarding flags stored via Hive box `ui_prefs`.
â€¢ Hydrate providers in `main()` before runApp.

5.6 Testing Strategy
â€¢ Widget tests use `ProviderScope(overrides: â€¦)` to inject fake repositories.
â€¢ State tests verify optimistic update rollback scenarios via `AsyncValue.guard`.

6. Consequences
Positive:
âœ“ High performance, fine-grained rebuild control.
âœ“ Minimal boilerplate via code-generation `riverpod_lint` & AI prompts.
âœ“ Comprehensive testing story.
âœ“ Native async/await ergonomics, no callback hell.
Negative / Trade-offs:
â€¢ Learning curve vs. simple setState.
â€¢ Manual cache invalidation â€“ mitigated with helper utilities.
â€¢ Potential dependency on Riverpod ecosystem health (mitigate by periodic review).

7. Validation / Success Metrics (Measured in PoC #3)
â€¢ Optimistic like update visible <50 ms (Median on mid-range device).
â€¢ Mutation round-trip p90 <300 ms with mock latency 80-150 ms.
â€¢ No unnecessary widget rebuilds (Flutter DevTools â†’ â‰¤2 renders on like flow).
â€¢ AI code generation first-iteration success â‰¥60 % for provider/mutation patterns.
â€¢ All unit/widget tests pass reliably in CI (â‰¥98 %).
â€¢ Offline flag disables queries & shows banner within 200 ms of connectivity change.

8. Review / Revisit
â€¢ Immediate: Upon completion of PoC #3 â€“ update Status to **VALIDATED** or **RECONSIDER**.
â€¢ If optimistic update patterns prove error-prone (>5 % rollback failures) â€“ explore flutter_query.
â€¢ Quarterly: Assess Riverpod ecosystem health & version upgrades.
â€¢ Major feature introductions (e.g., real-time streaming) may trigger re-evaluation.

Human Accountability: The WorldChef Mobile Team is responsible for implementing and validating this strategy, guided by AI support, and for updating this ADR post-PoC #3.

9. Validation Outcome (PoC #3)
PoC #3 achieved all success metrics:
â€¢ 100 % CI pass rate (43/43 tests) â€“ see test_run_g70.log (SHA A47DBE27â€¦D740)
â€¢ Optimistic-update median 36 ms, p90 mutation latency 210 ms
â€¢ AI first-iteration success 87.5 %
â€¢ Offline-banner latency 120 ms

Evidence artefacts stored in `docs/poc3_client_ui_state_integration/stage2_validation/`.

---
Previous status line retained above for audit. 